<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Mila Assist - Assistant virtuel pour streameur</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='style.css')}}"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      .botText span a {
        color: #ffff8d; /* Jaune p√¢le pour contraster avec le fond rouge #ef5350 */
        text-decoration: underline;
        font-weight: bold;
      }

      .botText span a:hover {
        color: #ffffa8; /* Un jaune l√©g√®rement plus clair au survol */
        text-decoration: none;
      }

      .model-status {
        font-size: 0.8em;
        color: #666;
        margin-left: 10px;
        display: none;
      }

      .model-status.loading {
        color: #ff9800;
        display: inline;
      }

      .model-status.ready {
        color: #4caf50;
        display: inline;
      }

      /* Styles simplifi√©s pour l'en-t√™te sans modes */
      .chat-header {
        text-align: center;
        padding: 15px;
      }

      .status-info {
        font-size: 0.9em;
        color: #ddd;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="chat-header">
        <h1>Mila Assist - Assistant virtuel pour streameur</h1>
        <div class="status-info">
          <span id="modelStatus" class="model-status">üß† Chargement...</span>
          <span style="color: #ddd; font-size: 0.8em;">Bientot les reformulations seront disponible</span>
        </div>
        <button id="quit" class="btn btn-danger">Quitter</button>
      </div>
      <div class="chat-body">
        <div id="chatbox">
          <div class="botText">
            <span>Bonjour, je suis Mila, votre assistant virtuel pour le streaming.</span>
          </div>
        </div>
      </div>
      <div class="chat-footer">
        <form>
          <input
            id="text"
            type="text"
            name="msg"
            placeholder="Tapez votre message..."
            class="form-control"
          />
          <button type="submit" id="send" class="btn btn-warning">
            Envoyer
          </button>
        </form>
        <div id="feedback" style="display: none">
          <button id="correct" class="btn btn-success">Correct</button>
          <button id="incorrect" class="btn btn-danger">Incorrect</button>
          <div id="expected-response" style="display: none">
            <input
              id="expected-text"
              type="text"
              name="expected"
              placeholder="R√©ponse attendue"
              class="form-control"
            />
            <button id="submit-expected" class="btn btn-primary">
              Soumettre
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Variable globale pour la session unique
      let currentSessionId = null;
      let lastQuestion = "";
      let lastResponse = "";

      function makeLinksClickable(text) {
        var urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, function (url) {
          return '<a href="' + url + '" target="_blank">' + url + "</a>";
        });
      }

      // Cr√©er une session unique au chargement de la page (SILENCIEUX)
      function initializeSession() {
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substr(2, 8);
        currentSessionId = `session_${timestamp}_${randomId}`;

        console.log("Session initialis√©e:", currentSessionId);
        // SUPPRIM√â: Plus d'affichage du message de session dans l'interface

        // V√©rifier le statut du mod√®le local
        checkModelStatus();
      }

      // V√©rifier le statut du mod√®le local
      function checkModelStatus() {
        $.get("/model_status")
          .done(function (data) {
            updateModelStatus(data.status, data.message);
          })
          .fail(function () {
            updateModelStatus("unknown", "Statut inconnu");
          });
      }

      // Mettre √† jour l'indicateur de statut du mod√®le
      function updateModelStatus(status, message) {
        const $status = $("#modelStatus");

        $status.removeClass("loading ready");

        if (status === "loading") {
          $status
            .addClass("loading")
            .text("üß† " + message)
            .show();
        } else if (status === "ready") {
          $status.addClass("ready").text("üß† " + message);
          // Masquer apr√®s 3 secondes quand pr√™t
          setTimeout(() => {
            $status.fadeOut();
          }, 3000);
        } else if (status === "error") {
          $status
            .addClass("loading")
            .text("‚ö†Ô∏è " + message)
            .show();
        } else {
          $status.hide();
        }
      }

      $(document).ready(function () {
        // Initialiser la session une seule fois au chargement
        initializeSession();

        // V√©rifier le statut du mod√®le p√©riodiquement si en cours de chargement
        setInterval(function () {
          if (
            $("#modelStatus").hasClass("loading") &&
            $("#modelStatus").is(":visible")
          ) {
            checkModelStatus();
          }
        }, 5000);

        // SUPPRIM√â: Gestion des modes de r√©ponse (plus utilis√©e)

        $("form").on("submit", function (event) {
          var rawText = $("#text").val().trim();
          if (rawText === "") {
            alert("Le champ de texte ne doit pas √™tre vide.");
            return false;
          }

          // Sauvegarder la question pour le feedback
          lastQuestion = rawText;

          var userHtml =
            '<div class="userText"><span>' + rawText + "</span></div>";
          $("#text").val("");
          $("#chatbox").append(userHtml);
          $(".chat-body").scrollTop($(".chat-body")[0].scrollHeight);

          // Indication de traitement
          var loadingHtml =
            '<div class="botText loading"><span>üí≠ Je r√©fl√©chis...</span></div>';
          $("#chatbox").append(loadingHtml);
          $(".chat-body").scrollTop($(".chat-body")[0].scrollHeight);

          // Utiliser la session existante
          var postData = {
            msg: rawText,
            session_id: currentSessionId,
          };

          $.ajax({
            data: postData,
            type: "POST",
            url: "/get",
          })
            .done(function (data) {
              // Suppression de l'indicateur de chargement
              $(".loading").remove();

              // Sauvegarder la r√©ponse pour le feedback
              lastResponse = data;

              var processedData = makeLinksClickable(data);
              var botHtml =
                '<div class="botText"><span>' + processedData + "</span></div>";
              $("#chatbox").append($.parseHTML(botHtml));
              $(".chat-body").scrollTop($(".chat-body")[0].scrollHeight);
              $("#feedback").show();
            })
            .fail(function (xhr, status, error) {
              $(".loading").remove();
              var errorHtml =
                '<div class="botText error"><span>‚ùå Erreur de connexion: ' +
                error +
                "</span></div>";
              $("#chatbox").append(errorHtml);
              $(".chat-body").scrollTop($(".chat-body")[0].scrollHeight);
            });
          event.preventDefault();
        });

        // SUPPRIM√â: Fonctions de gestion des modes (plus utilis√©es)

        $("#correct").on("click", function () {
          $("#feedback").hide();
        });

        $("#incorrect").on("click", function () {
          $("#expected-response").show();
        });

        $("#submit-expected").on("click", function () {
          var expectedText = $("#expected-text").val().trim();
          if (expectedText === "") {
            alert("Le champ de r√©ponse attendue ne doit pas √™tre vide.");
            return false;
          }

          $.ajax({
            data: {
              question: lastQuestion,
              expected: expectedText,
              current_response: lastResponse,
            },
            type: "POST",
            url: "/feedback",
          })
            .done(function (response) {
              $("#expected-response").hide();
              $("#feedback").hide();
              $("#expected-text").val("");

              var feedbackHtml =
                '<div class="botText system"><span>‚úÖ Feedback envoy√©. Merci !</span></div>';
              $("#chatbox").append(feedbackHtml);
              $(".chat-body").scrollTop($(".chat-body")[0].scrollHeight);
            })
            .fail(function () {
              var errorHtml =
                '<div class="botText error"><span>‚ùå Erreur lors de l\'envoi du feedback</span></div>';
              $("#chatbox").append(errorHtml);
            });
        });

        $("#quit").on("click", function () {
          if (confirm("√ätes-vous s√ªr de vouloir fermer l'application ?")) {
            $.ajax({
              type: "POST",
              url: "/quit",
            })
              .done(function (response) {
                alert(
                  "Application ferm√©e avec succ√®s. Vous pouvez fermer cette fen√™tre."
                );
                // Fermer la fen√™tre apr√®s 2 secondes
                setTimeout(function () {
                  window.close();
                }, 2000);
              })
              .fail(function () {
                alert("L'application va se fermer...");
                setTimeout(function () {
                  window.close();
                }, 1000);
              });
          }
        });

        // Nettoyer la session √† la fermeture de la page
        $(window).on("beforeunload", function () {
          if (currentSessionId) {
            // Optionnel: notifier l'API de la fin de session
            navigator.sendBeacon(
              "/api/sessions/end",
              JSON.stringify({ session_id: currentSessionId })
            );
          }
        });
      });
    </script>
  </body>
</html>